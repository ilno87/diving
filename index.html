<script>
/* DiveLog Pro ‚Äî SCRIPT FIXED
   - robust CSV parsing
   - safe numeric conversion
   - no random defaults for empty fields
   - safe numbering (no -1)
*/

const SHEETS_CONFIG_KEY = 'divelog_sheets_config';
const DEFAULT_GOOGLE_SHEETS_URL = ''; // metti qui l'URL se vuoi un default

let appState = {
    dives: [],
    sheetsUrl: DEFAULT_GOOGLE_SHEETS_URL,
    sheetsId: '',
    connected: false
};

document.addEventListener('DOMContentLoaded', () => {
    loadSheetsConfig();
    setupForm();
    updateSheetsButton();
    document.getElementById('data').value = new Date().toISOString().split('T')[0];
    console.log('üåä DiveLog Pro avviato (script aggiornato)');
});

/* ------------------------
   Helpers e conversioni
   ------------------------ */
function safeNumber(raw) {
    if (raw === null || raw === undefined) return null;
    const s = String(raw).trim();
    if (s === '') return null;
    // supporta virgola decimale
    const n = Number(s.replace(',', '.'));
    return Number.isFinite(n) ? n : null;
}

function safeInt(raw) {
    const n = safeNumber(raw);
    return n === null ? null : Math.trunc(n);
}

function formatDateISO(dateStr) {
    if (!dateStr) return '';
    const s = String(dateStr).trim();
    if (!s) return '';
    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // DD/MM/YYYY or D/M/YYYY
    let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (m) {
        const d = m[1].padStart(2, '0'), mo = m[2].padStart(2, '0'), y = m[3];
        return `${y}-${mo}-${d}`;
    }
    // Prova il Date parser
    const dt = new Date(s);
    if (!isNaN(dt.getTime())) {
        return dt.toISOString().split('T')[0];
    }
    return '';
}

function extractSheetsId(url) {
    if (!url) return '';
    const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    return match ? match[1] : '';
}

/* ------------------------
   CSV parsing robusto
   ------------------------ */
function parseCSVLine(line) {
    const values = [];
    let cur = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
            // escaped quote ""
            if (inQuotes && line[i + 1] === '"') {
                cur += '"';
                i++; // skip second quote
            } else {
                inQuotes = !inQuotes;
            }
        } else if (ch === ',' && !inQuotes) {
            values.push(cur);
            cur = '';
        } else {
            cur += ch;
        }
    }
    values.push(cur);
    return values.map(v => v.trim());
}

function parseCSV(text) {
    const rows = [];
    // split preservando eventuali righe vuote
    const lines = text.replace(/\r/g, '').split('\n');
    for (const line of lines) {
        // skip purely empty lines
        if (line.trim() === '') continue;
        rows.push(parseCSVLine(line));
    }
    return rows;
}

/* ------------------------
   Mappa CSV -> dives
   ------------------------ */
function parseCSVToDives(csvText) {
    const rows = parseCSV(csvText);
    if (rows.length === 0) return [];

    // header detection (case-insensitive)
    const header = rows[0].map(h => (h || '').toString().toLowerCase());
    const mapIdx = (names, fallback) => {
        for (let i = 0; i < header.length; i++) {
            const h = header[i];
            for (const n of names) if (h.includes(n)) return i;
        }
        return (typeof fallback === 'number') ? fallback : -1;
    };

    // colonne attese (fallback agli indici classici se header non riconosciuto)
    const idx = {
        numero: mapIdx(['num', 'numero'], 0),
        data:   mapIdx(['data', 'date'], 1),
        tipo:   mapIdx(['tipo', 'type'], 2),
        atmIN:  mapIdx(['atm in','atm_in','atm in (bar)','atm in (bar)','atm in'], 3),
        atmOUT: mapIdx(['atm out','atm_out','atm out (bar)','atm out'], 4),
        aria:   mapIdx(['aria','aria usata','used air','aria_usata'], 5),
        tempo:  mapIdx(['tempo','time','min'], 6),
        profMAX:mapIdx(['prof','prof max','prof max (metri)','profondit√†','profmax'], 7),
        tempMin:mapIdx(['temp min','temp_min','temp minima','temp min (¬∞c)','temp'], 8),
        tempMax:mapIdx(['temp max','temp_max','temp massima'], 9),
        sito:   mapIdx(['sito','site','location'], 10),
        note:   mapIdx(['note','notes','comment'], 11)
    };

    const dives = [];
    for (let r = 1; r < rows.length; r++) {
        const row = rows[r];
        // skip row se tutte le colonne sono vuote
        if (row.every(c => String(c || '').trim() === '')) continue;

        const val = i => (i >= 0 && i < row.length) ? row[i] : '';

        // numeri
        const numeroParsed = safeInt(val(idx.numero));
        const atmIN = safeNumber(val(idx.atmIN));
        const atmOUT = safeNumber(val(idx.atmOUT));
        let ariaUsata = safeInt(val(idx.aria));
        if (ariaUsata === null && atmIN !== null && atmOUT !== null) {
            ariaUsata = Math.max(0, Math.round(atmIN - atmOUT));
        }

        const tempoMinuti = safeInt(val(idx.tempo));
        const profMAX = safeNumber(val(idx.profMAX));
        const tempMin = safeNumber(val(idx.tempMin));
        const tempMax = safeNumber(val(idx.tempMax)) ?? (tempMin !== null ? tempMin : null);

        const dive = {
            id: Date.now() + r, // id locale
            numeroImmersione: Number.isFinite(numeroParsed) && numeroParsed > 0 ? numeroParsed : null,
            data: formatDateISO(val(idx.data)),
            tipo: (val(idx.tipo) || '').trim(),
            atmIN: atmIN,
            atmOUT: atmOUT,
            ariaUsata: ariaUsata,
            tempoMinuti: tempoMinuti,
            profMAX: profMAX,
            tempH2Omin: tempMin,
            tempH2Omax: tempMax,
            sito: (val(idx.sito) || '').trim(),
            note: (val(idx.note) || '').trim()
        };

        dives.push(dive);
    }

    // ordina per data (pi√π recente prima), se data mancante resta in coda
    dives.sort((a, b) => {
        const da = a.data ? new Date(a.data).getTime() : 0;
        const db = b.data ? new Date(b.data).getTime() : 0;
        if (db !== da) return db - da;
        const na = Number.isFinite(a.numeroImmersione) ? a.numeroImmersione : 0;
        const nb = Number.isFinite(b.numeroImmersione) ? b.numeroImmersione : 0;
        return nb - na;
    });

    return dives;
}

/* ------------------------
   UI: aggiornamenti e rendering
   ------------------------ */
function updateStats() {
    const dives = appState.dives;
    const currentYear = new Date().getFullYear();

    const total = dives.length;
    const maxDepth = dives.reduce((m, d) => {
        return Math.max(m, Number.isFinite(d.profMAX) ? d.profMAX : 0);
    }, 0);

    const totalTime = dives.reduce((s, d) => s + (Number.isFinite(d.tempoMinuti) ? d.tempoMinuti : 0), 0);

    const temps = dives.filter(d => Number.isFinite(d.tempH2Omin)).map(d => d.tempH2Omin);
    const avgTemp = temps.length ? (temps.reduce((a,b) => a + b, 0) / temps.length).toFixed(1) : '-';

    const thisYear = dives.filter(d => {
        if (!d.data) return false;
        const y = new Date(d.data).getFullYear();
        return y === currentYear;
    }).length;

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statMaxDepth').textContent = maxDepth ? (maxDepth + 'm') : '-';
    document.getElementById('statTotalTime').textContent = totalTime ? (totalTime + 'min') : '0min';
    document.getElementById('statAvgTemp').textContent = avgTemp === '-' ? '-¬∞C' : `${avgTemp}¬∞C`;
    document.getElementById('statThisYear').textContent = thisYear;
}

function renderDivesList() {
    const container = document.getElementById('divesContainer');
    const dives = appState.dives;

    if (!dives || dives.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">üìä</div>
                <h3>Nessuna immersione trovata</h3>
                <p>Carica i dati dal tuo Google Sheets o aggiungi la prima immersione</p>
            </div>
        `;
        return;
    }

    let html = `
        <table class="dive-table">
            <thead>
                <tr>
                    <th>Num.</th>
                    <th>Data</th>
                    <th>Sito</th>
                    <th>Tipo</th>
                    <th>Prof MAX</th>
                    <th>Tempo</th>
                    <th>Aria usata</th>
                    <th>Temp min</th>
                    <th>Temp max</th>
                </tr>
            </thead>
            <tbody>
    `;

    for (const d of dives) {
        const date = d.data ? new Date(d.data).toLocaleDateString('it-IT') : '-';
        const num = Number.isFinite(d.numeroImmersione) ? `#${d.numeroImmersione}` : '-';
        const sito = d.sito || '-';
        const tipoBadge = d.tipo ? `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 11px;">${d.tipo}</span>` : '-';
        const prof = Number.isFinite(d.profMAX) ? `${d.profMAX}m` : '-';
        const tempo = Number.isFinite(d.tempoMinuti) ? `${d.tempoMinuti}min` : '-';
        const aria = Number.isFinite(d.ariaUsata) ? `${d.ariaUsata}bar` : '-';
        const tmin = Number.isFinite(d.tempH2Omin) ? `${d.tempH2Omin}¬∞C` : '-';
        const tmax = Number.isFinite(d.tempH2Omax) ? `${d.tempH2Omax}¬∞C` : '-';

        html += `
            <tr>
                <td><strong>${num}</strong></td>
                <td>${date}</td>
                <td>${sito}</td>
                <td>${tipoBadge}</td>
                <td><strong>${prof}</strong></td>
                <td>${tempo}</td>
                <td>${aria}</td>
                <td>${tmin}</td>
                <td>${tmax}</td>
            </tr>
        `;
    }

    html += '</tbody></table>';
    container.innerHTML = html;
    updateStats();
}

/* ------------------------
   Form handling per aggiunta
   ------------------------ */
function setupForm() {
    const form = document.getElementById('diveForm');
    const atmIN = document.getElementById('atmIN');
    const atmOUT = document.getElementById('atmOUT');
    const ariaUsataEl = document.getElementById('ariaUsata');

    function calcolaAria() {
        const ingresso = safeNumber(atmIN.value);
        const uscita = safeNumber(atmOUT.value);
        if (ingresso !== null && uscita !== null) ariaUsataEl.value = Math.max(0, Math.round(ingresso - uscita));
        else ariaUsataEl.value = '';
    }
    atmIN.addEventListener('input', calcolaAria);
    atmOUT.addEventListener('input', calcolaAria);

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!appState.connected && !appState.sheetsUrl) {
            showError('‚ùå Google Sheets non configurato');
            return;
        }

        if (!validateForm()) return;

        const fd = new FormData(form);

        const atmInN = safeNumber(fd.get('atmIN'));
        const atmOutN = safeNumber(fd.get('atmOUT'));
        let ariaN = safeInt(fd.get('ariaUsata'));
        if (ariaN === null && atmInN !== null && atmOutN !== null) ariaN = Math.max(0, Math.round(atmInN - atmOutN));

        // calcola numero immersione in modo sicuro (ignora numeri non-finito/negativi)
        const maxNumero = appState.dives.reduce((m, d) => {
            const n = Number(d.numeroImmersione);
            return (Number.isFinite(n) && n > m) ? n : m;
        }, 0);
        const numeroImmersione = maxNumero + 1;

        const dive = {
            id: Date.now(),
            numeroImmersione: numeroImmersione,
            data: fd.get('data'),
            tipo: fd.get('tipo'),
            atmIN: atmInN,
            atmOUT: atmOutN,
            ariaUsata: ariaN,
            tempoMinuti: safeInt(fd.get('tempoMinuti')),
            profMAX: safeNumber(fd.get('profMAX')),
            tempH2Omin: safeNumber(fd.get('tempH2Omin')),
            tempH2Omax: safeNumber(fd.get('tempH2Omax')) ?? safeNumber(fd.get('tempH2Omin')),
            sito: fd.get('sito'),
            note: fd.get('note') || ''
        };

        try {
            setLoading(true);

            // prepara riga CSV (senza forzare valori default numerici)
            const row = [
                dive.numeroImmersione ?? '',
                dive.data ?? '',
                dive.tipo ?? '',
                Number.isFinite(dive.atmIN) ? dive.atmIN : '',
                Number.isFinite(dive.atmOUT) ? dive.atmOUT : '',
                Number.isFinite(dive.ariaUsata) ? dive.ariaUsata : '',
                Number.isFinite(dive.tempoMinuti) ? dive.tempoMinuti : '',
                Number.isFinite(dive.profMAX) ? dive.profMAX : '',
                Number.isFinite(dive.tempH2Omin) ? dive.tempH2Omin : '',
                Number.isFinite(dive.tempH2Omax) ? dive.tempH2Omax : '',
                `"${(dive.sito || '').replace(/"/g, '""')}"`,
                `"${(dive.note || '').replace(/"/g, '""')}"`
            ].join(',');

            // copia negli appunti
            await navigator.clipboard.writeText(row);
            showSuccess('üìã RIGA CSV copiata negli appunti ‚Äî incollala nel tuo Google Sheets come nuova riga.');

            // aggiorna localmente la vista
            appState.dives.unshift(dive);
            renderDivesList();
            form.reset();
            document.getElementById('data').value = new Date().toISOString().split('T')[0];
            ariaUsataEl.value = '';
        } catch (err) {
            // fallback
            const row = [
                dive.numeroImmersione ?? '',
                dive.data ?? '',
                dive.tipo ?? '',
                Number.isFinite(dive.atmIN) ? dive.atmIN : '',
                Number.isFinite(dive.atmOUT) ? dive.atmOUT : '',
                Number.isFinite(dive.ariaUsata) ? dive.ariaUsata : '',
                Number.isFinite(dive.tempoMinuti) ? dive.tempoMinuti : '',
                Number.isFinite(dive.profMAX) ? dive.profMAX : '',
                Number.isFinite(dive.tempH2Omin) ? dive.tempH2Omin : '',
                Number.isFinite(dive.tempH2Omax) ? dive.tempH2Omax : '',
                `"${(dive.sito || '').replace(/"/g, '""')}"`,
                `"${(dive.note || '').replace(/"/g, '""')}"`
            ].join(',');
            prompt('Copia questa riga e incollala nel tuo Google Sheets:', row);
            appState.dives.unshift(dive);
            renderDivesList();
            showSuccess('üìä Immersione preparata localmente! Copia la riga nel tuo Google Sheets.');
        } finally {
            setLoading(false);
        }
    });
}

function validateForm() {
    const atmIN = safeNumber(document.getElementById('atmIN').value);
    const atmOUT = safeNumber(document.getElementById('atmOUT').value);
    if (atmIN !== null && atmOUT !== null && atmOUT >= atmIN) {
        showError('‚ö†Ô∏è Atm OUT deve essere minore di Atm IN!');
        return false;
    }
    // altri controlli minimi se vuoi
    return true;
}

/* ------------------------
   Sync: caricamento da Sheets (CSV public)
   ------------------------ */
async function loadFromSheets() {
    if (!appState.sheetsUrl && !appState.sheetsId) {
        showError('‚ùå Google Sheets non configurato');
        return;
    }
    try {
        showLoading(true);
        updateConnectionStatus('üîÑ Caricamento da Google Sheets...');
        if (!appState.sheetsId) appState.sheetsId = extractSheetsId(appState.sheetsUrl);

        const csvUrl = `https://docs.google.com/spreadsheets/d/${appState.sheetsId}/export?format=csv&gid=0`;
        const res = await fetch(csvUrl);
        if (!res.ok) throw new Error('Sheets non accessibile. Verifica condivisione e ID.');
        const text = await res.text();
        const dives = parseCSVToDives(text);
        appState.dives = dives;
        appState.connected = true;
        updateConnectionStatus(`‚úÖ Sincronizzato (${dives.length} immersioni)`);
        updateConnectionInfo();
        renderDivesList();
        showSuccess(`üìä Caricate ${dives.length} immersioni da Google Sheets`);
    } catch (err) {
        console.error('Errore loadFromSheets:', err);
        showError('‚ùå Errore caricamento: ' + err.message);
        updateConnectionStatus('‚ùå Errore sincronizzazione');
    } finally {
        showLoading(false);
    }
}

/* ------------------------
   Export / Template
   ------------------------ */
function exportToSheets() {
    if (!appState.dives || appState.dives.length === 0) {
        showError('‚ö†Ô∏è Nessuna immersione da esportare');
        return;
    }
    const headers = ['Numero','Data','Tipo','Atm IN','Atm OUT','Aria usata','Tempo (min)','Prof MAX','Temp min','Temp max','Sito','Note'];
    const rows = appState.dives.map(d => [
        Number.isFinite(d.numeroImmersione) ? d.numeroImmersione : '',
        d.data || '',
        d.tipo || '',
        Number.isFinite(d.atmIN) ? d.atmIN : '',
        Number.isFinite(d.atmOUT) ? d.atmOUT : '',
        Number.isFinite(d.ariaUsata) ? d.ariaUsata : '',
        Number.isFinite(d.tempoMinuti) ? d.tempoMinuti : '',
        Number.isFinite(d.profMAX) ? d.profMAX : '',
        Number.isFinite(d.tempH2Omin) ? d.tempH2Omin : '',
        Number.isFinite(d.tempH2Omax) ? d.tempH2Omax : '',
        `"${(d.sito || '').replace(/"/g,'""')}"`,
        `"${(d.note || '').replace(/"/g,'""')}"`
    ].join(',')).join('\n');

    const csv = [headers.join(','), rows].join('\n');
    navigator.clipboard.writeText(csv).then(() => {
        showSuccess('üìã Tutti i dati copiati! Incollali nel tuo Google Sheets.');
    }).catch(() => {
        downloadFile(`immersioni_export_${new Date().toISOString().split('T')[0]}.csv`, csv, 'text/csv');
        showSuccess('üìä File CSV scaricato!');
    });
}

function createSheetsTemplate() {
    const headers = ['Numero','Data','Tipo','Atm IN','Atm OUT','Aria usata','Tempo (min)','Prof MAX','Temp min','Temp max','Sito','Note'];
    const template = [
        headers.join(','),
        '1,2024-08-10,Barca,200,50,150,45,25.5,18,20,Portofino,Ottima visibilit√†',
        '2,2024-08-11,Riva,180,60,120,35,12,20,22,Cinque Terre,Corrente leggera'
    ].join('\n');
    navigator.clipboard.writeText(template).then(() => {
        showSuccess('üìã Template copiato! Incollalo in un nuovo Google Sheets.');
    }).catch(() => {
        downloadFile('template_immersioni.csv', template, 'text/csv');
        showSuccess('üìä Template scaricato!');
    });
}

/* ------------------------
   Configurazione Sheets (localStorage)
   ------------------------ */
function loadSheetsConfig() {
    const saved = localStorage.getItem(SHEETS_CONFIG_KEY);
    if (saved) {
        try {
            const cfg = JSON.parse(saved);
            if (cfg.url) {
                appState.sheetsUrl = cfg.url;
                appState.sheetsId = extractSheetsId(cfg.url);
                appState.connected = !!appState.sheetsId;
                document.getElementById('settingsUrl').value = cfg.url;
                document.getElementById('sheetsUrl').value = cfg.url;
            }
        } catch (e) {
            console.warn('Errore parsing config:', e);
        }
    } else if (DEFAULT_GOOGLE_SHEETS_URL) {
        appState.sheetsUrl = DEFAULT_GOOGLE_SHEETS_URL;
        appState.sheetsId = extractSheetsId(DEFAULT_GOOGLE_SHEETS_URL);
        appState.connected = !!appState.sheetsId;
    }
}

function saveSheetsConfig(url) {
    localStorage.setItem(SHEETS_CONFIG_KEY, JSON.stringify({ url }));
    appState.sheetsUrl = url;
    appState.sheetsId = extractSheetsId(url);
    appState.connected = !!appState.sheetsId;
    updateSheetsButton();
    updateConnectionInfo();
}

function setupSheets() {
    const url = document.getElementById('sheetsUrl').value.trim();
    if (!url) {
        showError('‚ö†Ô∏è Inserisci l\'URL del Google Sheets');
        return;
    }
    saveSheetsConfig(url);
    showSuccess('‚úÖ Google Sheets configurato');
}

function updateSheetsConfig() {
    const url = document.getElementById('settingsUrl').value.trim();
    if (!url) {
        showError('‚ö†Ô∏è Inserisci un URL valido');
        return;
    }
    saveSheetsConfig(url);
    showSuccess('üîÑ Configurazione aggiornata');
}

function resetSheetsConfig() {
    if (!confirm('Rimuovere la configurazione Google Sheets?')) return;
    localStorage.removeItem(SHEETS_CONFIG_KEY);
    appState.sheetsUrl = '';
    appState.sheetsId = '';
    appState.connected = false;
    document.getElementById('settingsUrl').value = '';
    document.getElementById('sheetsUrl').value = '';
    updateSheetsButton();
    showSetupPanel();
    showSuccess('üîÑ Configurazione rimossa');
}

/* ------------------------
   UI helpers
   ------------------------ */
function updateSheetsButton() {
    const openBtn = document.getElementById('openSheetsBtn');
    if (appState.sheetsUrl) {
        openBtn.href = appState.sheetsUrl;
        openBtn.style.display = 'inline-flex';
    } else {
        openBtn.style.display = 'none';
    }
}

function updateConnectionStatus(msg) {
    const s = document.getElementById('statusIndicator');
    if (s) s.textContent = msg;
}

function updateConnectionInfo() {
    const info = document.getElementById('connectionInfo');
    if (!info) return;
    if (appState.connected) {
        info.innerHTML = `
            <strong>Google Sheets connesso:</strong> ‚úÖ<br>
            <strong>URL:</strong> <a href="${appState.sheetsUrl}" target="_blank">Apri Sheets</a><br>
            <strong>ID:</strong> ${appState.sheetsId || '-'}<br>
            <strong>Ultima sincronizzazione:</strong> ${new Date().toLocaleString('it-IT')}
        `;
    } else {
        info.innerHTML = `<p>Nessun foglio connesso</p>`;
    }
}

function showSetupPanel() {
    const p = document.getElementById('setupPanel');
    if (p) p.style.display = 'block';
    updateConnectionStatus('üìä Configura Google Sheets per iniziare');
}

function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function setLoading(loading) {
    const btn = document.querySelector('#diveForm button[type="submit"]');
    const text = document.getElementById('submitText');
    if (btn) btn.disabled = loading;
    if (text) text.textContent = loading ? '‚è≥ Preparazione...' : 'üìä Aggiungi a Google Sheets';
}

function showSuccess(msg) {
    const el = document.getElementById('successMessage');
    if (!el) return;
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showError(msg) {
    const el = document.getElementById('errorMessage');
    if (!el) return;
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 6000);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function downloadFile(filename, content, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
